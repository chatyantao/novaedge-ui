<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>NovaEdge Sora 服务控制台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-card: #0b1020;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.15);
      --danger: #ef4444;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --border: #1f2937;
      --success: #22c55e;
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: radial-gradient(circle at 20% 20%, #a855f7, #3b82f6);
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
    }

    .logo-text-main {
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 18px;
    }

    .logo-text-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .env-pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-sub);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 18px;
      margin-bottom: 18px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .card {
      background: radial-gradient(circle at 0 0, #111827 0, #020617 70%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.15);
      padding: 18px 18px 20px;
      box-shadow: 0 22px 45px rgba(15, 23, 42, 0.75);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 6px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-sub);
    }

    label {
      font-size: 12px;
      color: var(--text-sub);
      display: block;
      margin-bottom: 4px;
    }

    input,
    textarea {
      width: 100%;
      font: inherit;
      color: var(--text-main);
      background: #020617;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 9px 11px;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    input:focus,
    textarea:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
      background: #020617;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    .input-row {
      margin-bottom: 12px;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    button {
      font: inherit;
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #06b6d4);
      color: white;
      box-shadow: 0 14px 30px rgba(56, 189, 248, 0.45);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-sub);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: rgba(248, 113, 113, 0.08);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.5);
    }

    .btn-sm {
      padding: 5px 12px;
      font-size: 12px;
    }

    .btn-disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status-line {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 6px;
    }

    .status-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-sub);
    }

    .badge-success {
      border-color: rgba(34, 197, 94, 0.6);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.14);
    }

    .badge-danger {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.4);
    }

    .badge-info {
      border-color: rgba(59, 130, 246, 0.6);
      color: #bfdbfe;
      background: rgba(37, 99, 235, 0.16);
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-sub);
      background: rgba(15, 23, 42, 0.8);
    }

    .muted {
      color: var(--text-sub);
      font-size: 12px;
    }

    .result-box {
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      font-size: 12px;
      max-height: 180px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .alert {
      margin-top: 6px;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border-left: 3px solid rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    footer {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .link {
      color: #a5b4fc;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="logo">
        <div class="logo-mark"></div>
        <div>
          <div class="logo-text-main">NovaEdge · Sora 服务</div>
          <div class="logo-text-sub">试用 / 付费统一控制台</div>
        </div>
      </div>
      <div class="env-pill">
        API: <span id="apiBaseLabel">https://api.novaedge.vip</span>
      </div>
    </header>

    <!-- 上半部分：左侧登录 / 注册，右侧生成接口 -->
    <div class="grid">
      <!-- 登录 / 注册卡片 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">① 登录 / 注册</div>
            <div class="card-subtitle">登录后才能调用生成接口</div>
          </div>
          <button class="btn-sm btn-outline" onclick="openApiBasePrompt()">修改 API 地址</button>
        </div>

        <div class="input-row">
          <label>邮箱</label>
          <input type="email" id="emailInput" placeholder="you@example.com" />
        </div>

        <div class="input-row">
          <label>密码</label>
          <input type="password" id="passwordInput" placeholder="至少 6 位密码" />
        </div>

        <div class="btn-row">
          <button class="btn-primary" onclick="login()" id="loginBtn">登录</button>
          <button class="btn-outline" onclick="registerUser()" id="registerBtn">注册新用户</button>
          <button class="btn-outline btn-sm" onclick="logout()" id="logoutBtn">退出（清除 token）</button>
        </div>

        <div class="status-line">
          当前用户：
          <span id="currentUserEmail">尚未登录</span>
        </div>
        <div class="status-badges">
          <span class="badge" id="badgeLoginState">未登录</span>
          <span class="badge" id="badgePaid">付费状态未知</span>
          <span class="badge" id="badgeTrial">试用次数未知</span>
        </div>

        <div class="alert" id="authMessage" style="display:none;"></div>
      </section>

      <!-- 业务生成卡片 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">② 生成业务接口（/api/generate）</div>
            <div class="card-subtitle">这里放你真正要卖给用户的能力</div>
          </div>
          <span class="pill">未登录时无法调用</span>
        </div>

        <div class="input-row">
          <label>请求体 JSON（根据后端需要构造）</label>
          <textarea id="generateBodyInput" placeholder='例如：{"prompt": "帮我生成一段关于小狗的搞笑视频脚本"}'></textarea>
        </div>

        <div class="btn-row">
          <button class="btn-primary" onclick="callGenerate()" id="generateBtn">调用 /api/generate</button>
        </div>

        <div class="muted">提示：当返回 403 时，通常表示试用次数已用完。</div>

        <div class="result-box" id="generateResultBox">暂未调用。</div>
      </section>
    </div>

    <!-- 下半部分：试用用完提示 / 支付说明 -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">③ 试用用完后的提示区（可以在这里放二维码）</div>
          <div class="card-subtitle">当 /api/generate 返回 403 时，会把提示信息显示在这里</div>
        </div>
      </div>

      <div id="trialInfoBox" class="muted">
        当前尚未触发 403。这里可以写上：
        <br />· 试用额度介绍（例如：每个账号可免费调用 2 次）
        <br />· 付费版本说明（价格 / 有效期）
        <br />· 微信二维码 / 联系方式（你可以放图片或者链接）
      </div>
    </section>

    <footer>
      <span>NovaEdge · 内测版控制台</span>
      <span>后端：FastAPI · Cloudflare Tunnel &amp; Pages 部署</span>
    </footer>
  </div>

  <script>
    // === 配置区域 ===
    const API_BASE_KEY = "novaedge_api_base";
    const TOKEN_KEY = "novaedge_token";
    const USER_EMAIL_KEY = "novaedge_user_email";
    const USER_PAID_KEY = "novaedge_user_paid";
    const USER_TRIAL_LEFT_KEY = "novaedge_user_trial_left";

    function getApiBase() {
      return localStorage.getItem(API_BASE_KEY) || "https://api.novaedge.vip";
    }

    function setApiBase(url) {
      localStorage.setItem(API_BASE_KEY, url);
      document.getElementById("apiBaseLabel").textContent = url;
    }

    function openApiBasePrompt() {
      const current = getApiBase();
      const v = prompt("请输入后端 API Base URL（不要以 / 结尾）:", current);
      if (v && v.trim()) {
        setApiBase(v.trim());
      }
    }

    // === 初始化 ===
    function initFromStorage() {
      setApiBase(getApiBase());

      const token = localStorage.getItem(TOKEN_KEY);
      const email = localStorage.getItem(USER_EMAIL_KEY);
      const paid = localStorage.getItem(USER_PAID_KEY);
      const trialLeft = localStorage.getItem(USER_TRIAL_LEFT_KEY);

      if (token && email) {
        updateLoginState(true, email);
        updatePaidBadge(paid);
        updateTrialBadge(trialLeft);
      } else {
        updateLoginState(false, null);
      }
    }

    window.addEventListener("load", initFromStorage);

    // === UI 更新辅助函数 ===
    function updateLoginState(isLoggedIn, email) {
      const emailSpan = document.getElementById("currentUserEmail");
      const loginBadge = document.getElementById("badgeLoginState");
      const generateBtn = document.getElementById("generateBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (isLoggedIn) {
        emailSpan.textContent = email || "已登录";
        loginBadge.textContent = "已登录";
        loginBadge.classList.remove("badge-danger");
        loginBadge.classList.add("badge-success");
        generateBtn.classList.remove("btn-disabled");
        generateBtn.disabled = false;
        logoutBtn.disabled = false;
      } else {
        emailSpan.textContent = "尚未登录";
        loginBadge.textContent = "未登录";
        loginBadge.classList.remove("badge-success");
        loginBadge.classList.add("badge-danger");
        generateBtn.classList.add("btn-disabled");
        generateBtn.disabled = true;
        logoutBtn.disabled = true;
      }
    }

    function updatePaidBadge(isPaid) {
      const badge = document.getElementById("badgePaid");
      if (isPaid === "true" || isPaid === true) {
        badge.textContent = "已付费";
        badge.classList.remove("badge-danger");
        badge.classList.add("badge-success");
      } else if (isPaid === "false" || isPaid === false) {
        badge.textContent = "未付费";
        badge.classList.remove("badge-success");
        badge.classList.add("badge-danger");
      } else {
        badge.textContent = "付费状态未知";
        badge.classList.remove("badge-success", "badge-danger");
      }
    }

    function updateTrialBadge(trialLeft) {
      const badge = document.getElementById("badgeTrial");
      if (trialLeft === null || trialLeft === undefined || trialLeft === "") {
        badge.textContent = "试用次数未知";
        badge.classList.remove("badge-success", "badge-danger");
        return;
      }
      const n = Number(trialLeft);
      if (Number.isNaN(n)) {
        badge.textContent = "试用次数未知";
        return;
      }
      badge.textContent = `剩余试用：${n} 次`;
      badge.classList.remove("badge-danger");
      badge.classList.add(n > 0 ? "badge-success" : "badge-danger");
    }

    function setAuthMessage(msg, isError = false) {
      const box = document.getElementById("authMessage");
      if (!msg) {
        box.style.display = "none";
        return;
      }
      box.textContent = msg;
      box.style.display = "block";
      box.style.borderLeftColor = isError
        ? "rgba(248,113,113,0.9)"
        : "rgba(34,197,94,0.9)";
    }

    // === 登录 / 注册 / 退出 ===
    async function login() {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value;

      if (!email || !password) {
        setAuthMessage("请填写邮箱和密码。", true);
        return;
      }

      try {
        setAuthMessage("正在登录中…");
        const res = await fetch(getApiBase() + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          const text = await res.text();
          setAuthMessage("登录失败：" + text, true);
          updateLoginState(false, null);
          return;
        }

        const data = await res.json();

        // 这里假设后端返回结构：
        // {
        //   "access_token": "...",
        //   "token_type": "bearer",
        //   "user": {
        //       "email": "...",
        //       "is_paid": false,
        //       "trial_left": 2
        //   }
        // }
        const token = data.access_token;
        const user = data.user || {};
        localStorage.setItem(TOKEN_KEY, token);
        localStorage.setItem(USER_EMAIL_KEY, user.email || email);
        if (user.is_paid !== undefined) {
          localStorage.setItem(USER_PAID_KEY, String(user.is_paid));
        }
        if (user.trial_left !== undefined) {
          localStorage.setItem(USER_TRIAL_LEFT_KEY, String(user.trial_left));
        }

        updateLoginState(true, user.email || email);
        updatePaidBadge(user.is_paid);
        updateTrialBadge(user.trial_left);
        setAuthMessage("登录成功，token 已保存。", false);
      } catch (err) {
        console.error(err);
        setAuthMessage("登录异常：" + err.message, true);
      }
    }

    async function registerUser() {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value;

      if (!email || !password) {
        setAuthMessage("注册前请先填写邮箱和密码。", true);
        return;
      }

      try {
        setAuthMessage("正在注册中…");
        const res = await fetch(getApiBase() + "/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email,
            password
          })
        });

        if (!res.ok) {
          const text = await res.text();
          setAuthMessage("注册失败：" + text, true);
          return;
        }

        setAuthMessage("注册成功，请继续点击登录。", false);
      } catch (err) {
        console.error(err);
        setAuthMessage("注册异常：" + err.message, true);
      }
    }

    function logout() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_EMAIL_KEY);
      localStorage.removeItem(USER_PAID_KEY);
      localStorage.removeItem(USER_TRIAL_LEFT_KEY);
      updateLoginState(false, null);
      updatePaidBadge(null);
      updateTrialBadge(null);
      setAuthMessage("已退出登录，本地 token 已清除。", false);
    }

    // === 调用业务接口 /api/generate ===
    async function callGenerate() {
      const token = localStorage.getItem(TOKEN_KEY);
      if (!token) {
        setAuthMessage("请先登录后再调用生成接口。", true);
        return;
      }

      let bodyText = document.getElementById("generateBodyInput").value.trim();
      if (!bodyText) {
        // 默认一个简单请求体，避免用户不知道写什么
        bodyText = JSON.stringify({ prompt: "hello from novaedge-ui" }, null, 2);
        document.getElementById("generateBodyInput").value = bodyText;
      }

      let bodyJson;
      try {
        bodyJson = JSON.parse(bodyText);
      } catch (err) {
        alert("请求体不是合法 JSON，请检查。");
        return;
      }

      const resultBox = document.getElementById("generateResultBox");
      resultBox.textContent = "调用中…";

      try {
        const res = await fetch(getApiBase() + "/api/generate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify(bodyJson)
        });

        const text = await res.text();
        resultBox.textContent = text;

        if (res.status === 403) {
          // 试用次数用完
          document.getElementById("trialInfoBox").innerHTML =
            "后端返回 403，说明试用次数可能已用完。<br>" +
            "你可以在这里放：微信收款码、续费说明、联系客服方式等。";
        }

        // 如果后端在返回体里带了最新 trial_left / is_paid，可以在这里解析更新：
        try {
          const data = JSON.parse(text);
          if (data.user) {
            if (data.user.trial_left !== undefined) {
              localStorage.setItem(
                USER_TRIAL_LEFT_KEY,
                String(data.user.trial_left)
              );
              updateTrialBadge(data.user.trial_left);
            }
            if (data.user.is_paid !== undefined) {
              localStorage.setItem(USER_PAID_KEY, String(data.user.is_paid));
              updatePaidBadge(data.user.is_paid);
            }
          }
        } catch (_) {
          // 返回不是 JSON 就忽略
        }
      } catch (err) {
        console.error(err);
        resultBox.textContent = "调用异常：" + err.message;
      }
    }
  </script>
</body>
</html>
